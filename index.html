<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Monitor de Qualidade do Ar</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    img { width: 400px; border: 2px solid #444; margin-top: 10px; }
    button { padding: 10px 20px; margin-right: 10px; }
  </style>
</head>
<body>
<h1>Monitor de Qualidade do Ar</h1>

<div>
  <label for="mode">Modo:</label>
  <select id="mode">
    <option value="multimodal">Imagem + Sensores</option>
    <option value="image_only">S√≥ Imagem</option>
  </select>
  <br><br>
  <button onclick="startCapture()">‚ñ∂ Iniciar Captura</button>
  <button onclick="stopCapture()">‚èπ Parar Captura</button>
  <button onclick="captureOnce()">üì∏ Captura √önica</button>
</div>

<h2>Imagem Atual</h2>
<img id="camera" src="/image.jpg?cache=0">

<h2>√öltimo Relat√≥rio</h2>
<pre id="report">Ainda n√£o h√° dados...</pre>

<script>
  let intervalId;

  // Atualiza imagem e relat√≥rio do backend
  async function updateReport() {
    try {
      const res = await fetch("/latest");
      const data = await res.json();
      document.getElementById("report").textContent = JSON.stringify(data, null, 2);
      refreshImage();
    } catch (err) {
      console.error("Erro ao atualizar relat√≥rio:", err);
    }
  }

  function refreshImage() {
    document.getElementById("camera").src = "/image.jpg?cache=" + new Date().getTime();
  }

  async function startCapture() {
    const mode = document.getElementById("mode").value;
    await fetch("/start_capture", {
      method: "POST",
      body: new URLSearchParams({interval: 60, mode})
    });
    if (!intervalId) intervalId = setInterval(updateReport, 5000);
  }

  async function stopCapture() {
    await fetch("/stop_capture", {method:"POST"});
    if (intervalId) { clearInterval(intervalId); intervalId = null; }
  }

  async function captureOnce() {
    const mode = document.getElementById("mode").value;
    const pm25 = 0, co = 0, co2 = 0; // tempor√°rio, o Pi envia os dados
    const formData = new FormData();
    formData.append("mode", mode);
    formData.append("pm25", pm25);
    formData.append("co", co);
    formData.append("co2", co2);
    // imagem s√≥ no Raspberry
    try {
      const res = await fetch("/capture_once", {method:"POST", body: formData});
      const data = await res.json();
      document.getElementById("report").textContent = JSON.stringify(data, null, 2);
      refreshImage();
    } catch (err) {
      console.error("Erro ao capturar:", err);
    }
  }

  // Atualiza relat√≥rio e imagem a cada 15s, mesmo sem iniciar captura
  setInterval(updateReport, 15000);
</script>
</body>
</html>
